
// ==UserScript==
// @name        ML
// @match       https://wplace.live/*
// @grant       none
// @inject-into page
// @run-at      document-start
// ==/UserScript==

(()=>{var t={id:null,tx:0,ty:0,px:0,py:0,w:0,h:0,e:!1},v=1e3,O=3;var C=null,I=Math;async function U(n,y){let[a,p]=y,o=t,s=v,i=O,x=await createImageBitmap(n),u=s*i,c=document.createElement("canvas");c.width=c.height=u;let m=c.getContext("2d");m.imageSmoothingEnabled=!1,m.drawImage(x,0,0,u,u);let b=o.tx*s+o.px,T=o.ty*s+o.py,E=a*s,L=p*s,e=I.max(0,E-b),g=I.max(0,L-T),l=I.min(o.w-e,s-(b+e-E)),h=I.min(o.h-g,s-(T+g-L)),d=I.max(0,b-E)*i,S=I.max(0,T-L)*i;if(C||(C=document.createElement("canvas"),C.width=o.w,C.height=o.h,C.getContext("2d").putImageData(o.id,0,0)),l>0&&h>0){let f=document.createElement("canvas"),X=l*i,M=h*i;f.width=X,f.height=M;let k=f.getContext("2d");k.imageSmoothingEnabled=!1,k.drawImage(C,e,g,l,h,0,0,X,M);let W=k.getImageData(0,0,X,M),F=W.data;for(let Y=0;Y<F.length;Y+=4)(Y/4%X%i!==1||I.floor(Y/4/X)%i!==1)&&(F[Y+3]=0);k.putImageData(W,0,0),m.drawImage(f,d,S)}return await new Promise(f=>c.toBlob(f))}function z(){let n=window.fetch;window.fetch=async function(...y){let a=await n.apply(this,y),p=a.clone(),o=(y[0].url||y[0])+"";if((p.headers.get("content-type")||"").includes("image/")&&o.includes("/tiles/")&&o.endsWith(".png")){let i=o.match(/\/tiles\/(\d+)\/(\d+)\.png/);if(!i||!t.e||!t.id)return a;let x=+i[1],u=+i[2],c=Math.floor((t.tx*v+t.px+t.w-1)/v),m=Math.floor((t.ty*v+t.py+t.h-1)/v);if(x<t.tx||x>c||u<t.ty||u>m)return a;try{let b=await U(await p.blob(),[x,u]);return new Response(b,{headers:p.headers,status:a.status,statusText:a.statusText})}catch{return a}}return a}}var w=document,r=n=>w.getElementById(n),D=n=>w.createElement(n);function _(){if(r("ms"))return;let n=D("style");n.id="ms",n.textContent=".p{position:fixed;z-index:9;right:12px;bottom:12px;width:200px;background:#111;color:#fff;border:1px solid #e33;font:12px system-ui}.p *{box-sizing:border-box}.h{display:flex;align-items:center;justify-content:space-between;padding:6px;background:#111}#h{touch-action:none;user-select:none}.tl{color:#e33}.m{width:22px;height:22px;border:none;background:#333;color:#fff}.c{padding:8px}.g{display:grid;grid-template-columns:1fr 1fr;gap:6px;margin:0 0 6px}.i{width:100%;min-width:0;padding:6px;border:1px solid #333;background:#000;color:#ddd}.b{width:100%;padding:6px;border:none;color:#fff;font-size:11px;margin:0 0 4px}.bp{background:#e33}.bs{background:#555}",w.head.appendChild(n)}function B(){_();let n=D("div");n.id="m",n.className="p",n.innerHTML='<div id="h" class="h"><div class="tl">ML</div><button id="z" class="m">-</button></div><div id="c" class="c"><div class="g"><input id="x" class="i" placeholder="tX"/><input id="y" class="i" placeholder="tY"/><input id="px" class="i" placeholder="pX"/><input id="py" class="i" placeholder="pY"/></div><button id="s" class="b bp">Load Image</button><button id="t" class="b bs">OFF</button></div>',w.body.appendChild(n);let y=r("h"),a=r("c"),p=r("z"),o=r("x"),s=r("y"),i=r("px"),x=r("py"),u=r("s"),c=r("t");p.onclick=()=>{let e=a.style.display!=="none";a.style.display=e?"none":"block",p.textContent=e?"+":"-"},u.onclick=()=>{let e=D("input");e.type="file",e.accept="image/*",e.onchange=g=>{let l=g.target.files[0];if(!l)return;let h=l.name.match(/^(\d+)-(\d+)-(\d+)-(\d+)/);h&&(o.value=h[1],s.value=h[2],i.value=h[3],x.value=h[4]);let d=new Image;d.onload=()=>{let S=D("canvas");S.width=d.width,S.height=d.height;let f=S.getContext("2d");f.drawImage(d,0,0),t.id=f.getImageData(0,0,d.width,d.height),t.w=d.width,t.h=d.height},d.src=URL.createObjectURL(l)},e.click()},c.onclick=()=>{!t.e&&(t.tx=+o.value||0,t.ty=+s.value||0,t.px=+i.value||0,t.py=+x.value||0,!t.id)||(t.e=!t.e,c.textContent=t.e?"ON":"OFF",c.classList.toggle("bp",t.e),c.classList.toggle("bs",!t.e))};let m=!1,b,T,E=(e,g)=>{let l=n.getBoundingClientRect();b=e-l.left,T=g-l.top,m=!0},L=(e,g)=>{m&&(n.style.left=e-b+"px",n.style.top=g-T+"px",n.style.bottom="auto")};"onpointerdown"in window&&(y.onpointerdown=e=>{e.target.id!=="z"&&(E(e.clientX,e.clientY),e.preventDefault())},w.onpointermove=e=>L(e.clientX,e.clientY),w.onpointerup=()=>m=!1),p.onpointerdown=e=>e.stopPropagation()}function R(){let n=()=>setTimeout(B,1e3);w.readyState==="loading"?w.addEventListener("DOMContentLoaded",n):n()}z();R();})();
