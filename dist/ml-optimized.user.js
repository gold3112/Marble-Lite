
// ==UserScript==
// @name        ML
// @match       https://wplace.live/*
// @grant       none
// @inject-into page
// @run-at      document-start
// ==/UserScript==

(()=>{var t={id:null,tx:0,ty:0,px:0,py:0,w:0,h:0,e:0},v=1e3,W=3;var E,I=Math;async function F(n,w){let[s,u]=w,o=t,c=v,a=W,r=c*a,y=await createImageBitmap(n),d=document.createElement("canvas");d.width=d.height=r;let m=d.getContext("2d");m.imageSmoothingEnabled=0,m.drawImage(y,0,0,r,r);let f=o.tx*c+o.px,T=o.ty*c+o.py,L=s*c,S=u*c,e=I.max(0,L-f),g=I.max(0,S-T),l=I.min(o.w-e,c-(f+e-L)),h=I.min(o.h-g,c-(T+g-S));if(E||(E=document.createElement("canvas"),E.width=o.w,E.height=o.h,E.getContext("2d").putImageData(o.id,0,0)),l>0&&h>0){let i=document.createElement("canvas"),x=l*a,C=h*a;i.width=x,i.height=C;let X=i.getContext("2d");X.imageSmoothingEnabled=0,X.drawImage(E,e,g,l,h,0,0,x,C);let D=X.getImageData(0,0,x,C),M=D.data;for(let k=0;k<M.length;k+=4)(k/4%x%a!==1||I.floor(k/4/x)%a!==1)&&(M[k+3]=0);X.putImageData(D,0,0),m.drawImage(i,I.max(0,f-L)*a,I.max(0,T-S)*a)}return new Promise(i=>d.toBlob(i))}function O(){let n=window.fetch;window.fetch=async function(...w){let s=await n.apply(this,w),u=s.clone(),o=(w[0].url||w[0])+"";if((u.headers.get("content-type")||"").includes("image/")&&o.includes("/tiles/")&&o.endsWith(".png")){let a=o.match(/\/tiles\/(\d+)\/(\d+)\.png/);if(!a||!t.e||!t.id)return s;let r=+a[1],y=+a[2],d=Math.floor((t.tx*v+t.px+t.w-1)/v),m=Math.floor((t.ty*v+t.py+t.h-1)/v);if(r<t.tx||r>d||y<t.ty||y>m)return s;try{let f=await F(await u.blob(),[r,y]);return new Response(f,{headers:u.headers,status:s.status,statusText:s.statusText})}catch{return s}}return s}}var b=document,p=n=>b.getElementById(n),Y=n=>b.createElement(n);function z(){if(p("ms"))return;let n=Y("style");n.id="ms",n.textContent=".p{position:fixed;z-index:9;right:12px;bottom:12px;width:200px;background:#111;color:#fff;border:1px solid #e33;font:12px system-ui}.p *{box-sizing:border-box}.h{display:flex;align-items:center;justify-content:space-between;padding:6px;background:#111}#h{touch-action:none;user-select:none}.tl{color:#e33}.m{width:22px;height:22px;border:none;background:#333;color:#fff}.c{padding:8px}.g{display:grid;grid-template-columns:1fr 1fr;gap:6px;margin:0 0 6px}.i{width:100%;min-width:0;padding:6px;border:1px solid #333;background:#000;color:#ddd}.b{width:100%;padding:6px;border:none;color:#fff;font-size:11px;margin:0 0 4px}.bp{background:#e33}.bs{background:#555}",b.head.appendChild(n)}function R(){z();let n=Y("div");n.id="m",n.className="p",n.innerHTML='<div id="h" class="h"><div class="tl">ML</div><button id="z" class="m">-</button></div><div id="c" class="c"><div class="g"><input id="x" class="i" placeholder="tX"/><input id="y" class="i" placeholder="tY"/><input id="px" class="i" placeholder="pX"/><input id="py" class="i" placeholder="pY"/></div><button id="s" class="b bp">Load Image</button><button id="t" class="b bs">OFF</button></div>',b.body.appendChild(n);let w=p("h"),s=p("c"),u=p("z"),o=p("x"),c=p("y"),a=p("px"),r=p("py"),y=p("s"),d=p("t");u.onclick=()=>{let e=s.style.display!=="none";s.style.display=e?"none":"block",u.textContent=e?"+":"-"},y.onclick=()=>{let e=Y("input");e.type="file",e.accept="image/*",e.onchange=g=>{let l=g.target.files[0];if(!l)return;let h=l.name.match(/^(\d+)-(\d+)-(\d+)-(\d+)/);h&&(o.value=h[1],c.value=h[2],a.value=h[3],r.value=h[4]);let i=new Image;i.onload=()=>{let x=Y("canvas");x.width=i.width,x.height=i.height;let C=x.getContext("2d");C.drawImage(i,0,0),t.id=C.getImageData(0,0,i.width,i.height),t.w=i.width,t.h=i.height},i.src=URL.createObjectURL(l)},e.click()},d.onclick=()=>{!t.e&&(t.tx=+o.value||0,t.ty=+c.value||0,t.px=+a.value||0,t.py=+r.value||0,!t.id)||(t.e=!t.e,d.textContent=t.e?"ON":"OFF",d.classList.toggle("bp",t.e),d.classList.toggle("bs",!t.e))};let m=!1,f,T,L=(e,g)=>{let l=n.getBoundingClientRect();f=e-l.left,T=g-l.top,m=!0},S=(e,g)=>{m&&(n.style.left=e-f+"px",n.style.top=g-T+"px",n.style.bottom="auto")};"onpointerdown"in window&&(w.onpointerdown=e=>{e.target.id!=="z"&&(L(e.clientX,e.clientY),e.preventDefault())},b.onpointermove=e=>S(e.clientX,e.clientY),b.onpointerup=()=>m=!1),u.onpointerdown=e=>e.stopPropagation()}function U(){let n=()=>setTimeout(R,1e3);b.readyState==="loading"?b.addEventListener("DOMContentLoaded",n):n()}O();U();})();
